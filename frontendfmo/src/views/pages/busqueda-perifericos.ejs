<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head') %>
    <title>B√∫squeda Perif√©ricos</title>
    <style>
        /* --- ESTILOS COMPACTOS (Paper Form) --- */
        .paper-form {
            background-color: #fff;
            border: 2px solid #000;
            color: #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .cell-border {
            border: 1px solid #000;
            padding: 2px 5px;
            display: flex;
            align-items: center;
        }
        .input-line {
            border: none;
            background: transparent;
            width: 100%;
            font-weight: bold;
            color: #000080;
            height: 20px;
            font-size: 13px;
            padding: 0 5px;
        }
        .input-line:focus { outline: none; }
        .label-text {
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .form-check { margin-bottom: 0; margin-right: 10px; display: flex; align-items: center;}
        .form-check-input { border: 1px solid #000; width: 14px; height: 14px; margin-top: 0; margin-right: 5px; border-radius: 0;}
        .row-compact { --bs-gutter-x: 0; }
    </style>
</head>
<body>
    <div class="wrapper">
        <%- include('../partials/sidebar') %>
        <div id="content" class="w-100 bg-light p-4">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <a href="/busqueda" class="btn btn-outline-secondary btn-sm">‚¨Ö Volver al Men√∫</a>
                <h5 class="m-0 fw-bold">‚å®Ô∏è Historial de Perif√©ricos</h5>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    
                    <div class="row g-2 align-items-center mb-4">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold">Filtrar por:</label>
                            <select class="form-select" id="filtroSelect" onchange="cambiarFiltro()">
                                <option value="todo">Listar Todo</option>
                                <option value="serial">Serial / FMO</option>
                                <option value="fecha">Fecha</option>
                            </select>
                        </div>

                        <div class="col-md-7" id="containerInputSerial" style="display: none;">
                            <label class="form-label small fw-bold">Ingrese Serial o FMO:</label>
                            <input type="text" class="form-control" id="inputBusquedaSerial" placeholder="Ej: 452 o S/N...">
                        </div>

                        <div class="col-md-7" id="containerInputFecha" style="display: none;">
                            <label class="form-label small fw-bold">Seleccione Fecha:</label>
                            <input type="date" class="form-control" id="inputBusquedaFecha">
                        </div>

                        <div class="col-md-7" id="containerVacio"></div>

                        <div class="col-md-2 text-end">
                            <label class="form-label d-block">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="buscarPerifericos()">üîç Buscar</button>
                        </div>
                    </div>

                    <div class="table-responsive table-scroll-wrapper">
                        <table class="table table-hover table-bordered align-middle">
                            <thead class="table-light text-center">
                                <tr>
                                    <th width="5%">#</th>
                                    <th>FMO/SERIAL</th>
                                    <th>Tipo Componente</th>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResultados" class="text-center">
                                <tr><td colspan="6" class="text-muted">Seleccione un filtro y busque para ver resultados.</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVerPeriferico" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light py-2">
                    <h6 class="modal-title fw-bold">üìÑ Detalle del Recibo</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-secondary bg-opacity-10">
                    
                    <div class="paper-form container p-0" id="formPerifericosModal">
                        
                        <div class="row row-compact">
                            <div class="col-12 text-center cell-border justify-content-center bg-light p-2">
                                <h6 class="m-0 fw-bold" style="letter-spacing: 1px;">RECIBO DE PERIF√âRICOS Y COMPONENTES</h6>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FECHA:</span>
                                <input type="text" class="input-line" id="modal_fecha" readonly style="max-width: 150px;">
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FICHA:</span>
                                <input type="number" class="input-line" id="modal_ficha" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">USUARIO:</span>
                                <input type="text" class="input-line" id="modal_usuario" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">EXT/TLF:</span>
                                <input type="text" class="input-line" id="modal_ext" readonly>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_1" disabled>
                                    <label class="label-text" style="font-size: 11px;">MONITOR</label>
                                </div>
                            </div>
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_2" disabled>
                                    <label class="label-text" style="font-size: 11px;">TECLADO</label>
                                </div>
                            </div>
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_6" disabled>
                                    <label class="label-text" style="font-size: 11px;">SCANER</label>
                                </div>
                            </div>
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_7" disabled>
                                    <label class="label-text" style="font-size: 11px;">PENDRIVES</label>
                                </div>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_4" disabled>
                                    <label class="label-text" style="font-size: 11px;">REGULADOR</label>
                                </div>
                            </div>
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_5" disabled>
                                    <label class="label-text" style="font-size: 11px;">IMPRESORA</label>
                                </div>
                            </div>
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_3" disabled>
                                    <label class="label-text" style="font-size: 11px;">MOUSE</label>
                                </div>
                            </div>
                            <div class="col-3 cell-border">
                                <div class="form-check">
                                    <input class="form-check-input modal-peri-check" type="checkbox" id="chk_8" disabled>
                                    <label class="label-text" style="font-size: 11px;">T√ìNER</label>
                                </div>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <div class="form-check p-0 m-0 w-100">
                                    <span class="label-text me-2">COMPONENTES:</span>
                                    <input type="text" class="input-line" id="modal_componenteTexto" readonly placeholder="Ninguno">
                                </div>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <div class="form-check p-0 m-0 w-100">
                                    <span class="label-text me-2">OTROS:</span>
                                    <input type="text" class="input-line" id="modal_otros" readonly placeholder="Ninguno">
                                </div>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FMO/ SERIAL:</span>
                                <input type="text" class="input-line" id="modal_fmoSerial" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FMO ASIGNADO:</span>
                                <input type="text" class="input-line" id="modal_fmoAsignado" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">DPTO/GCIA:</span>
                                <input type="text" class="input-line" id="modal_gerencia" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FALLA:</span>
                                <input type="text" class="input-line" id="modal_falla" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">ASIGNADO A:</span>
                                <input type="text" class="input-line" id="modal_asignadoA" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">N.¬∫ SOLICITUD S.T.:</span>
                                <input type="text" class="input-line" id="modal_solicitudST" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">N.¬∫ SOLICITUD DAET:</span>
                                <input type="text" class="input-line" id="modal_solicitudDaet" readonly> 
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border" style="height: 45px;">
                                <span class="label-text">ENTREGADO POR:</span>
                                <input type="text" class="input-line" id="modal_entregadoPor" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border" style="height: 45px;">
                                <span class="label-text">RECIBIDO POR:</span>
                                <input type="text" class="input-line" id="modal_recibidoPor" readonly>
                            </div>
                        </div>

                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger"onclick="generarPDFRecibo()">üñ®Ô∏è PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap/bootstrap.bundle.min.js"></script>

    <script src="/js/html2pdf.bundle.min.js"></script>

    <script src="/js/pdf.js"></script>

<script>
    // --- 1. L√ìGICA DE FILTROS ---
    function cambiarFiltro() {
        const filtro = document.getElementById('filtroSelect').value;
        const divSerial = document.getElementById('containerInputSerial');
        const divFecha = document.getElementById('containerInputFecha');
        const divVacio = document.getElementById('containerVacio');

        divSerial.style.display = 'none';
        divFecha.style.display = 'none';
        divVacio.style.display = 'none';

        if (filtro === 'serial') divSerial.style.display = 'block';
        else if (filtro === 'fecha') divFecha.style.display = 'block';
        else divVacio.style.display = 'block';
    }

    // --- 2. L√ìGICA DE B√öSQUEDA ---
    async function buscarPerifericos() {
        const filtro = document.getElementById('filtroSelect').value;
        let url = 'http://127.0.0.1:8081/api/buscarReciboPerifericos'; 

        if (filtro === 'serial') {
            const val = document.getElementById('inputBusquedaSerial').value;
            if(!val) return alert("Ingrese Serial");
            url = `http://127.0.0.1:8081/api/buscarReciboPerifericos/${val}`;
        } 
        else if (filtro === 'fecha') {
            const val = document.getElementById('inputBusquedaFecha').value;
            if(!val) return alert("Seleccione Fecha");
            url = `http://127.0.0.1:8081/api/buscarReciboPerifericos/fecha/${val}`;
        }

        const tbody = document.getElementById('tablaResultados');
        tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';

        try {
            const response = await fetch(url);
            if(!response.ok) throw new Error("Error de servidor.");
            const data = await response.json();
            renderizarTabla(data);
        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" class="text-danger">${error.message}</td></tr>`;
        }
    }

    function renderizarTabla(data) {
        const tbody = document.getElementById('tablaResultados');
        tbody.innerHTML = '';
        const lista = Array.isArray(data) ? data : [data];

        if(lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No hay registros.</td></tr>';
            return;
        }

        lista.forEach((item, index) => {
            // L√≥gica para determinar qu√© mostrar en la columna "Tipo"
            let tipoMostrar = "Varios";
            if (item.componentePerifericos && item.componentePerifericos.length > 0) tipoMostrar = "Componente Interno";
            else if (item.perifericos && item.perifericos.length > 0) tipoMostrar = "Perif√©rico";
            else if (item.otro) tipoMostrar = "Otro";

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="fw-bold">${index + 1}</td>
                <td class="text-primary fw-bold">${item.fmoSerial || "S/N"}</td>
                <td><span class="badge bg-secondary">${tipoMostrar}</span></td>
                <td>${item.fecha || "N/A"}</td>
                <td>${item.usuario || "N/A"}</td>
                <td>
                    <button class="btn btn-sm btn-info text-white" onclick='abrirModalVer(${JSON.stringify(item)})'>
                        üëÅÔ∏è Ver
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 3. L√ìGICA DE VISUALIZACI√ìN (MODAL) ---
    function abrirModalVer(data) {
        console.log("Datos recibidos en modal:", data);

        // A. RESETEAR CAMPOS (Limpieza previa)
        document.querySelectorAll('.modal-peri-check').forEach(c => c.checked = false);
        setVal('modal_componenteTexto', "");
        setVal('modal_otros', "");

        // B. MAPEO DE CAMPOS SIMPLES
        setVal('modal_fecha', data.fecha);
        setVal('modal_usuario', data.usuario); // El payload dice 'nombre', no 'usuario' (aunque hay campo usuario)
        setVal('modal_ficha', data.ficha);
        setVal('modal_ext', data.extension); 
        
        setVal('modal_fmoSerial', data.fmoSerial);
        setVal('modal_fmoAsignado', data.fmoEquipo); // A veces no viene en payload plano, verificar
        setVal('modal_gerencia', data.gerencia);
        setVal('modal_falla', data.falla);
        setVal('modal_solicitudST', data.solicitudST);
        setVal('modal_solicitudDaet', data.solicitudDAET);
        
        setVal('modal_asignadoA', data.asignadoA);
        setVal('modal_entregadoPor', data.entregadoPor);
        setVal('modal_recibidoPor', data.recibidoPor);

        // C. MAPEO DE PERIF√âRICOS (Checkboxes)
        // El payload trae: "perifericos": [ { "id": 1 }, { "id": 5 } ]
        if (data.perifericos && data.perifericos.length > 0) {
            data.perifericos.forEach(p => {
                // Construimos el ID del checkbox: 'chk_' + id
                // Ejemplo: ID 1 -> busca 'chk_1' (Monitor) y lo marca.
                const checkId = 'chk_' + p.id;
                const checkbox = document.getElementById(checkId);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }

        // D. MAPEO DE COMPONENTES INTERNOS (Texto)
        // El payload trae: "componentePerifericos": [ { "idComponente": 10 } ]
        // Necesitamos convertir ID 10 -> "FAN COOLER"
        const mapNombresComponentes = {
            3: "MEMORIA RAM",
            4: "DISCO DURO",
            5: "TARJETA MADRE",
            6: "PROCESADOR",
            7: "TARJETA DE VIDEO",
            8: "FUENTE DE PODER",
            9: "TARJETA DE RED",
            10: "FAN COOLER",
            11: "PILA"
        };

        if (data.componentePerifericos && data.componentePerifericos.length > 0) {
            // Creamos un array con los nombres encontrados
            const nombres = data.componentePerifericos.map(c => {
                return mapNombresComponentes[c.idComponente] || ("ID " + c.idComponente);
            });
            // Los unimos con comas por si hay m√°s de uno
            setVal('modal_componenteTexto', nombres.join(", "));
        }

        // E. MAPEO DE OTROS
        // El payload trae: "otro": "Incluye regleta"
        if (data.otro) {
            setVal('modal_otros', data.otro);
        }

        // F. MOSTRAR MODAL
        const myModal = new bootstrap.Modal(document.getElementById('modalVerPeriferico'));
        myModal.show();
    }

    // Helper para setear valor seguro (si es null pone vac√≠o)
    function setVal(id, val) {
        const el = document.getElementById(id);
        if(el) el.value = val || "";
    }
</script>
</body>
</html>