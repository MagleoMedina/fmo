<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head') %>
    <title>Exportar Reportes</title>
<style>
    /* --- 1. ESTILOS ORIGINALES (Tus estilos de siempre) --- */
        .paper-form {
            background-color: #fff;
            border: 2px solid #000;
            color: #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            width: 85%;
            margin: 0 auto;
            height: 70%;
        }
    

        .cell-border {
            border: 1px solid #000;
            padding: 2px 5px;
            display: flex;
            align-items: center;
        }

    .cell-block { display: block; }

        .input-line {
            border: none;
            background: transparent;
            width: 100%;
            font-weight: bold;
            color: #000080;
            height: 20px;
            font-size: 13px;
            padding: 0 5px;
        }
    .input-line:focus { outline: none; }

    .label-text {
        font-weight: bold;
        font-size: 0.75rem;
        text-transform: uppercase;
        white-space: nowrap;
    }

    .form-check {
        min-height: auto;
        margin-bottom: 0;
        margin-right: 10px;
        }
    .form-check-input { 
        border: 1px solid #000 !important; /* Forzar borde en checkbox */
        width: 13px; 
        height: 13px; 
        margin-top: 3px; 
        appearance: auto; /* Ayuda a que html2canvas lo renderice mejor */
    }
    
    .row-compact { --bs-gutter-x: 0; }
    
    .tag-badge {
        background-color: #000080;
        color: white;
        padding: 1px 3px;
        border-radius: 4px;
        margin-right: 4px;
        font-size: 10px;
    }

    /* --- 2. CONFIGURACIN TCNICA PARA LA EXPORTACIN --- */
    
    /* Contenedor de Templates (OCULTO) */
    #templates-container { display: none; }

    /* Estilo para el contenedor de impresi贸n */
    #print-staging-area {
        background: white;
        width: 816px; /* Ancho exacto Carta */
        margin: 0 auto;
    }
    
    /* Salto de p谩gina */
    .html2pdf__page-break {
        height: 20px;
        background: white;
        display: block;
    }

    /* Ocultar botones dentro del PDF por si acaso */
    .paper-form button, .paper-form .btn { display: none !important; }
</style>
</head>
<body>
    <div class="wrapper">
        <%- include('../partials/sidebar') %>
        <div id="content" class="w-100 bg-light p-4">
            
            <h4 class="mb-4 fw-bold"> Exportaci贸n Masiva de Registros</h4>

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Tipo de Registro:</label>
                            <select class="form-select" id="selTipo">
                                <option value="equipos">Recibo de Equipos</option>
                                <option value="perifericos">Recibo de Perif茅ricos</option>
                                <option value="daet">Entregas al DAET</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-bold">Formato:</label>
                            <select class="form-select" id="selFormato" onchange="toggleFormato()">
                                <option value="pdf">PDF (Documentos)</option>
                                <option value="csv">CSV (Excel)</option>
                            </select>
                        </div>

                        <div class="col-md-2 date-group">
                            <label class="form-label fw-bold">Desde:</label>
                            <input type="date" class="form-control" id="fechaInicio">
                        </div>
                        <div class="col-md-2 date-group">
                            <label class="form-label fw-bold">Hasta:</label>
                            <input type="date" class="form-control" id="fechaFin">
                        </div>

                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="procesarExportacion()">
                                 Generar Exportaci贸n
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="statusArea" class="mt-3"></div>

        </div>
    </div>

<div id="templates-container" style="display:none;">
    <div id="template-equipos-wrapper"><%- include('../partials/forms/template-equipos') %></div>
    <div id="template-perifericos-wrapper"><%- include('../partials/forms/template-perifericos') %></div>
    <div id="template-daet-wrapper"><%- include('../partials/forms/template-daet') %></div>
</div>

<script src="/js/jspdf.umd.min.js"></script>
<script src="/js/html2canvas.min.js"></script>
<script src="/js/bootstrap/bootstrap.bundle.min.js"></script>
<script src="/js/html2pdf.bundle.min.js"></script>
<script src="/js/mappings.js"></script> 
<script src="/js/pdf.js"></script>

    <script>
        function toggleFormato() {
            // L贸gica simple por si quieres ocultar fechas en CSV
            const fmt = document.getElementById('selFormato').value;
            // Opcional: mostrar u ocultar inputs
        }

        async function procesarExportacion() {
            const tipo = document.getElementById('selTipo').value;
            const formato = document.getElementById('selFormato').value;
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;

            if (formato === 'pdf') {
                if(!inicio || !fin) return alert("Seleccione el rango de fechas");
                
                // 1. Fetch a tu API de rango (Ajusta tus rutas)
                // Ej: /api/recibo-equipos/rango?inicio=...&fin=...
                let url = '';
                if(tipo === 'equipos') url = `http://127.0.0.1:8081/api/buscarReciboEquipos/rangoFechas/${inicio}/${fin}`;
                else if(tipo === 'perifericos') url = `http://127.0.0.1:8081/api/buscarReciboPerifericos/rangoFechas/${inicio}/${fin}`;
                else if(tipo === 'daet') url = `http://127.0.0.1:8081/api/buscarEntregasAlDaet/rangoFechas/${inicio}/${fin}`;

                try {
                    document.getElementById('statusArea').innerHTML = '<div class="alert alert-info">Cargando datos...</div>';
                    
                    const res = await fetch(url); 
                    const data = await res.json();
                    console.log(data);
                    
                    if(data.length === 0) {
                        document.getElementById('statusArea').innerHTML = '<div class="alert alert-warning">No hay registros en ese rango.</div>';
                        return;
                    }

                    // LLAMADA A LA NUEVA FUNCIN EN PDF.JS
                    document.getElementById('statusArea').innerHTML = '<div class="alert alert-warning">Generando PDF masivo, por favor espere...</div>';
                    
                    await generarPDFMasivo(data, tipo);
                    
                    document.getElementById('statusArea').innerHTML = '<div class="alert alert-success">PDF Generado.</div>';

                } catch (error) {
                    console.error(error);
                    alert("Error al exportar");
                }
            } else {
               // Como es una descarga directa de archivo, usamos window.location o un enlace oculto.
        // Asumiendo que quieres un reporte general unificado o dependiendo del tipo:
        if(!inicio || !fin) return alert("Seleccione el rango de fechas para el archivo CSV");

        let url = `http://127.0.0.1:8081/api/exportarCsv/${inicio}/${fin}`;
        
        // Si necesitas diferenciar tipos en el CSV, deber铆as mandar el tipo al backend tambi茅n:
        // let url = `http://.../api/exportar/csv?tipo=${tipo}&inicio=${inicio}&fin=${fin}`;

        // Truco para descargar sin cambiar de p谩gina:
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', ''); // El nombre lo pone el backend (Content-Disposition)
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        document.getElementById('statusArea').innerHTML = '<div class="alert alert-success">Descarga CSV iniciada.</div>';
            }
        }
    </script>
<div id="print-staging-area"></div>

</body>

    
</html>