<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head') %>
    <title><%= title %></title>
    <style>
        /* REUTILIZAMOS EL ESTILO "PAPER" COMPACTO */
        .paper-form {
            background-color: #fff;
            border: 2px solid #000;
            color: #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            max-width: 550px;
            margin: 0 auto;
        }
        
        .cell-border {
            border: 1px solid #000;
            padding: 2px 5px;
            display: flex;
            align-items: center;
        }

        .cell-block { display: block; }

        .input-line {
            border: none;
            background: transparent;
            width: 100%;
            font-weight: bold;
            color: #000080;
            height: 20px;
            font-size: 13px;
            padding: 0 5px;
        }
        .input-line:focus { outline: none; }

        .label-text {
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* Ajustes espec√≠ficos para este formulario */
        .form-check-input {
            border: 1px solid #000;
            width: 14px;
            height: 14px;
            margin-top: 2px;
            margin-right: 5px;
        }
        
        .row-compact { --bs-gutter-x: 0; }
        
        .header-title {
            letter-spacing: 2px;
            font-weight: 900;
            text-decoration: underline;
        }

        /* Clase para deshabilitar visualmente */
        .disabled-section {
            opacity: 0.5;
            pointer-events: none;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>

    <div class="wrapper">
        <%- include('../partials/sidebar') %>

        <div id="content" class="w-100 bg-light p-2" style="overflow-y: auto;">
            
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-dark m-0">üöö Env√≠os al DAET</h5>
                    <button class="btn btn-sm btn-primary" onclick="guardarEntregaDAET()">üíæ Guardar Entrega</button>
                </div>

                <div class="paper-form container p-0" id="formDaet">
                    
                    <div class="row row-compact">
                        <div class="col-12 text-center cell-border justify-content-between bg-light p-2">
                            <div style="width: 30px;"></div> <span class="header-title">ENTREGAS AL DAET</span>
                            <span style="font-size: 20px;">üì¶</span> </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">FECHA:</span>
                            <input type="date" class="input-line" id="fecha" style="max-width: 150px;">
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">SOLICITUD DAET.:</span>
                            <input type="text" class="input-line" id="solicitudDAET">
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">SOLICITUD S.T.:</span>
                            <input type="text" class="input-line" id="solicitudST">
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">ANALISTA:</span>
                            <input type="text" class="input-line" id="analista" placeholder="Usuario Actual">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border justify-content-center bg-light">
                            <span class="label-text">ACTIVIDAD:</span>
                        </div>
                        <div class="col-12 cell-border justify-content-center">
                            <div class="form-check form-check-inline me-5">
                                <input class="form-check-input" type="radio" name="actividad" id="actReemplazo" value="Reemplazo">
                                <label class="label-text" for="actReemplazo">REEMPLAZO</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="actividad" id="actEntrega" value="Entrega" checked>
                                <label class="label-text" for="actEntrega">ENTREGA</label>
                            </div>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-3">ESTADO:</span>
                            <div class="form-check form-check-inline me-4">
                                <input class="form-check-input" type="radio" name="estado" id="estBueno" value="Bueno" checked>
                                <label class="label-text" for="estBueno">BUENO</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="estado" id="estDanado" value="Da√±ado">
                                <label class="label-text" for="estDanado">DA√ëADO</label>
                            </div>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">EQUIPO:</span>
                            <input type="text" class="input-line" id="nombreEquipo" placeholder="Escriba aqu√≠ si env√≠a un CPU completo">
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">COMPONENTES:</span>
                            <select class="input-line" id="selectComponentes" style="cursor: pointer;">
                                <option value="" selected></option>
                                <option value="3">MEMORIA RAM</option>
                                <option value="4">DISCO DURO</option>
                                <option value="5">TARJETA MADRE</option>
                                <option value="6">PROCESADOR</option>
                                <option value="7">TARJETA DE VIDEO</option>
                                <option value="8">FUENTE DE PODER</option>
                                <option value="9">TARJETA DE RED</option>
                                <option value="10">FAN COOLER</option>
                                <option value="11">PILA</option>
                            </select>
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">PERIF√âRICOS:</span>
                            <select class="input-line" id="selectPerifericos" style="cursor: pointer;">
                                <option value="" selected></option>
                                <option value="1">MONITOR</option>
                                <option value="2">TECLADO</option>
                                <option value="3">MOUSE</option>
                                <option value="4">REGULADOR</option>
                                <option value="5">IMPRESORA</option>
                                <option value="6">SCANER</option>
                                <option value="7">PENDRIVES</option>
                                <option value="8">TONER</option>
                            </select>
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">FMO/SERIAL:</span>
                            <input type="text" class="input-line" id="fmoSerial">
                        </div>
                    </div>

                    <div id="wrapperEntregaCpu">
                        <div class="row row-compact">
                            <div class="col-12 cell-border bg-light">
                                <span class="label-text">ENTREGA DE CPU (Detalles):</span>
                            </div>
                        </div>
                        
                        <div class="row row-compact">
                            <div class="col-6 cell-border cell-block">
                                <div class="form-check mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkDisco" value="Disco Duro">
                                    <label class="label-text" for="chkDisco">DISCO DURO</label>
                                </div>
                                
                                <div class="d-flex align-items-center mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkRam" value="Memoria RAM">
                                    <label class="label-text me-1" for="chkRam">MEMORIAS RAM</label>
                                    <span style="font-size:10px;">----</span>
                                    <span class="label-text ms-1 me-1">CANT:</span>
                                    <input type="number" class="input-line text-center" id="cantRam" value="1" style="width: 40px; height: 20px;">
                                </div>

                                <div class="form-check mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkMadre" value="Tarjeta Madre">
                                    <label class="label-text" for="chkMadre">TARJETA MADRE</label>
                                </div>
                                <div class="form-check mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkProc" value="Procesador">
                                    <label class="label-text" for="chkProc">PROCESADOR</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkFan" value="Fan Cooler">
                                    <label class="label-text" for="chkFan">FAN COOLER</label>
                                </div>
                            </div>

                            <div class="col-6 cell-border cell-block">
                                <div class="form-check mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkVideo" value="Tarjeta de Video">
                                    <label class="label-text" for="chkVideo">TARJETA DE VIDEO</label>
                                </div>
                                
                                <div class="form-check mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkFuente" value="Fuente de Poder">
                                    <label class="label-text" for="chkFuente">FUENTE DE PODER</label>
                                </div>

                                <div class="form-check mb-1">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkPila" value="Pila">
                                    <label class="label-text" for="chkPila">PILA</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input daet-check" type="checkbox" id="chkRed" value="Tarjeta de Red">
                                    <label class="label-text" for="chkRed">TARJETA DE RED</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border bg-light justify-content-center">
                            <span class="label-text">SE RECIBE REEMPLAZO</span>
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-12 cell-border align-items-center">
                            <div class="form-check form-check-inline ms-2">
                                <input class="form-check-input" type="radio" name="reemplazo" id="reemplazoSi" value="Si">
                                <label class="label-text" for="reemplazoSi">SI</label>
                            </div>
                            <div class="form-check form-check-inline me-4">
                                <input class="form-check-input" type="radio" name="reemplazo" id="reemplazoNo" value="No" checked>
                                <label class="label-text" for="reemplazoNo">NO</label>
                            </div>
                            
                            <span class="label-text me-2 border-start border-dark ps-2">IDENTIFIQUE:</span>
                            <input type="text" class="input-line" id="identifiqueReemplazo">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border cell-block">
                            <span class="label-text">(OBSERVACI√ìN):</span>
                            <textarea class="input-line" rows="2" id="observacion" style="resize: none;"></textarea>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-8 cell-border" style="height: 50px;">
                            <span class="label-text">RECIBIDO POR:</span>
                            <input type="text" class="input-line mt-3" id="recibidoPor">
                        </div>
                        <div class="col-4 cell-border" style="height: 50px;">
                            <span class="label-text">FICHA:</span>
                            <input type="text" class="input-line mt-3" id="fichaRecibido">
                        </div>
                    </div>

                </div>
                <br>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const fechaInput = document.getElementById('fecha');
        if(fechaInput) fechaInput.valueAsDate = new Date();
        initValidations(); // Inicializar exclusividad de campos
    });

    // --- 1. VALIDACI√ìN VISUAL (Mutua Exclusividad) ---
    function initValidations() {
        const inputEquipo = document.getElementById('nombreEquipo');
        const selectComp = document.getElementById('selectComponentes');
        const selectPeri = document.getElementById('selectPerifericos');
        const wrapperCpu = document.getElementById('wrapperEntregaCpu');
        
        const toggleCpuCheckboxes = (disable) => {
            if (disable) {
                wrapperCpu.classList.add('disabled-section');
                wrapperCpu.querySelectorAll('input').forEach(chk => {
                    chk.disabled = true;
                    chk.checked = false;
                });
            } else {
                wrapperCpu.classList.remove('disabled-section');
                wrapperCpu.querySelectorAll('input').forEach(chk => chk.disabled = false);
            }
        };

        inputEquipo.addEventListener('input', (e) => {
            if (e.target.value.trim() !== "") {
                selectComp.disabled = true; selectComp.value = "";
                selectPeri.disabled = true; selectPeri.value = "";
                toggleCpuCheckboxes(false); // Habilitar checkboxes para equipo
            } else {
                selectComp.disabled = false;
                selectPeri.disabled = false;
            }
        });

        selectComp.addEventListener('change', (e) => {
            if (e.target.value !== "") {
                inputEquipo.disabled = true; inputEquipo.value = "";
                selectPeri.disabled = true; selectPeri.value = "";
                toggleCpuCheckboxes(true); // Deshabilitar checkboxes
            } else {
                inputEquipo.disabled = false;
                selectPeri.disabled = false;
                toggleCpuCheckboxes(false);
            }
        });

        selectPeri.addEventListener('change', (e) => {
            if (e.target.value !== "") {
                inputEquipo.disabled = true; inputEquipo.value = "";
                selectComp.disabled = true; selectComp.value = "";
                toggleCpuCheckboxes(true); // Deshabilitar checkboxes
            } else {
                inputEquipo.disabled = false;
                selectComp.disabled = false;
                toggleCpuCheckboxes(false);
            }
        });
    }

    // --- 2. LOGICA DE ENV√çO CON ESTRUCTURA JSON ESPEC√çFICA ---
    async function guardarEntregaDAET() {
        console.log("Iniciando recolecci√≥n de datos...");
        
        const inputEquipo = document.getElementById('nombreEquipo').value;
        const selectComp = document.getElementById('selectComponentes').value;
        const selectPeri = document.getElementById('selectPerifericos').value;
        const fmoSerial = document.getElementById('fmoSerial').value;

        // Validar selecci√≥n
        if (!inputEquipo && !selectComp && !selectPeri) {
            alert("‚ö†Ô∏è Selecciona Equipo, Componente o Perif√©rico.");
            return;
        }

        // Mapa IDs Checkboxes
        const mapComponentesIds = {
            'chkRam': 3, 'chkDisco': 4, 'chkMadre': 5, 'chkProc': 6,
            'chkVideo': 7, 'chkFuente': 8, 'chkRed': 9, 'chkFan': 10, 'chkPila': 11
        };

        // --- VARIABLES DEL PAYLOAD ---
        let idPerifericoFinal = null;
        let componenteUnicoFinal = null;
        let componentesInternosFinal = null;

        // CASO 1: PERIF√âRICO (Monitor, etc.)
        if (selectPeri) {
            idPerifericoFinal = parseInt(selectPeri);
            componenteUnicoFinal = null;
            componentesInternosFinal = null;
        } 
        // CASO 2: COMPONENTE √öNICO (Lista Desplegable)
        else if (selectComp) {
            idPerifericoFinal = null; // No hay perif√©rico, es un componente suelto
            componentesInternosFinal = null;
            
            componenteUnicoFinal = [{
                idComponente: parseInt(selectComp),
                cantidad: 1 // Default para suelto
            }];
        }
        // CASO 3: EQUIPO COMPLETO (Input Texto + Checkboxes)
        else if (inputEquipo) {
            idPerifericoFinal = 1; // ID 1 representa CPU/Equipo Base
            componenteUnicoFinal = null;
            componentesInternosFinal = [];

            // RAM
            const ramCheck = document.getElementById('chkRam');
            if (ramCheck && ramCheck.checked) {
                componentesInternosFinal.push({
                    idComponente: mapComponentesIds['chkRam'],
                    cantidad: parseInt(document.getElementById('cantRam').value) || 1
                });
            }
            // Otros Checkboxes
            document.querySelectorAll('.daet-check:checked:not(#chkRam)').forEach(chk => {
                const id = mapComponentesIds[chk.id];
                if (id) componentesInternosFinal.push({ idComponente: id, cantidad: 1 });
            });
        }

        const getVal = (id) => document.getElementById(id)?.value || "";

        // --- CONSTRUCCI√ìN DEL PAYLOAD FINAL ---
        const payload = {
            asignadoA: getVal('analista') || null,
            estatus: "En Proceso", 
            fecha: getVal("fecha"),
            ficha: getVal('fichaRecibido') || null,
            
            // FMO Equipo (Encabezado)
            fmoEquipo: getVal('nombreEquipo')|| null, 
            
            observacion: getVal('observacion')|| null,
            recibidoPor: getVal('recibidoPor') || null,
            
            solicitudDAET: getVal('solicitudDAET') || null,
            solicitudST: getVal('solicitudST') || null,

            entregas: [
                {
                    actividad: document.querySelector('input[name="actividad"]:checked')?.value || "Entrega",
                    estado: document.querySelector('input[name="estado"]:checked')?.value || "Bueno",
                    
                    fmoSerial: fmoSerial,
                    identifique: getVal('identifiqueReemplazo')|| null, 
                    
                    // Aqu√≠ asignamos las variables calculadas arriba
                    idPeriferico: idPerifericoFinal,
                    componenteUnico: componenteUnicoFinal,
                    componentesInternos: componentesInternosFinal
                }
            ]
        };

        console.log("Payload generado:", JSON.stringify(payload, null, 2));

        try {
            const response = await fetch('http://127.0.0.1:8081/api/crearEntregasAlDaet', { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(response.ok) {
                alert("‚úÖ Entrega DAET registrada con √©xito");
               window.location.reload();
            } else {
                const text = await response.text();
                alert("‚ùå Error en el servidor: " + text);
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå Error de conexi√≥n: " + e.message);
        }
    }
    </script>
</body>
</html>