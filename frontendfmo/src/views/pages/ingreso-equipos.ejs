<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head') %>
    <title><%= title %></title>
    <style>
        /* --- ESTILOS COMPACTOS --- */
        .paper-form {
            background-color: #fff;
            border: 2px solid #000;
            color: #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px; /* Fuente m치s peque침a para todo el form */
            max-width: 900px; /* Evita que se estire demasiado en monitores grandes */
            margin: 0 auto; /* Centrar */
        }
        
        /* Celdas con bordes negros y poco relleno */
        .cell-border {
            border: 1px solid #000;
            padding: 2px 5px; /* Arriba/Abajo 2px, Lados 5px -> MUCHO M츼S COMPACTO */
            display: flex; /* Ayuda a alinear verticalmente label e input */
            align-items: center; /* Centrar verticalmente */
        }

        /* Bloques que no son flex (para los checkboxes en grid) */
        .cell-block {
            display: block;
        }

        /* Inputs invisibles m치s delgados */
        .input-line {
            border: none;
            
            background: transparent;
            width: 100%;
            font-weight: bold;
            color: #000080;
            height: 20px; /* Altura forzada peque침a */
            font-size: 13px;
            padding: 0 5px;
        }
        .input-line:focus {
            outline: none;
        }

        /* Etiquetas */
        .label-text {
            font-weight: bold;
            font-size: 0.75rem; /* Letra peque침a */
            text-transform: uppercase;
            white-space: nowrap; /* Evita que el texto salte de l칤nea si es posible */
        }

        /* Ajuste de Checkboxes para que no ocupen tanto espacio vertical */
        .form-check {
            min-height: auto;
            margin-bottom: 0; /* Sin margen inferior */
            margin-right: 10px;
        }
        .form-check-input {
            border: 1px solid #000;
            width: 13px;
            height: 13px;
            margin-top: 3px;
        }
        
        /* Utilidad para filas sin separaci칩n */
        .row-compact {
            --bs-gutter-x: 0; /* Quita espacio horizontal entre columnas */
        }
    </style>
</head>
<body>

    <div class="wrapper">
        <%- include('../partials/sidebar') %>

        <div id="content" class="w-100 bg-light p-2" style="overflow-y: auto;">
            
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-dark m-0">游닇 Ingreso de Equipos</h5>
                    <button class="btn btn-sm btn-primary" onclick="guardarRecibo()">游 Guardar</button>
                </div>

                <div class="paper-form container p-0" id="formularioPapel">
                    
                    <div class="row row-compact">
                        <div class="col-12 text-center cell-border justify-content-center bg-light" style="padding: 4px;">
                            <h6 class="m-0 fw-bold">RECIBO DE EQUIPOS</h6>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">FECHA:</span>
                            <input type="date" class="input-line" id="fecha" required style="max-width: 130px;">
                        </div>
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">USUARIO:</span>
                            <input type="text" class="input-line" id="usuario">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">FICHA:</span>
                            <input type="number" class="input-line" id="ficha">
                        </div>
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">CLAVE:</span>
                            <input type="password" class="input-line" id="clave">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text me-2">NOMBRE:</span>
                            <input type="text" class="input-line" id="nombre">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-5 cell-border">
                            <span class="label-text me-2">EXT./TLF.:</span>
                            <input type="text" class="input-line" id="extension">
                        </div>
                        <div class="col-md-7 cell-border justify-content-between">
                                <span class="label-text me-3">RESPALDO:</span>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="respaldo" id="respaldoSi" value="Si">
                                <label class="form-check-label label-text" for="respaldoSi">SI</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="respaldo" id="respaldoNo" value="No">
                                <label class="form-check-label label-text" for="respaldoNo">NO</label>
                            </div>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border">
                            <span class="label-text">GCIA./DPTO.:</span>
                            <input type="text" class="input-line ms-2" id="gerencia">

                        
                         </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">SOLIC. DAET:</span>
                            <input type="text" class="input-line" id="solicitudDAET">
                        </div>
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">SOLIC. S.T.:</span>
                            <input type="text" class="input-line" id="solicitudST">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-4 cell-border cell-block">
                            <span class="label-text">CPU FMO:</span>
                            <input type="text" class="input-line" id="fmoEquipo">
                        </div>
                        <div class="col-md-4 cell-border cell-block">
                            <span class="label-text">MARCA:</span>
                            <input type="text" class="input-line" id="marca">
                        </div>
                        <div class="col-md-4 cell-border cell-block">
                            <span class="label-text">FALLA:</span>
                            <input type="text" class="input-line" id="falla">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-4 cell-border cell-block py-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="form-check">
                                    <input class="form-check-input componente-check" type="checkbox" id="checkRam">
                                    <label class="form-check-label label-text" for="checkRam">MEM. RAM</label>
                                </div>
                                <div class="d-flex align-items-center" style="width: 80px;">
                                    <span class="label-text me-1" style="font-size: 9px;">CANT:</span>
                                    <input type="number" class="input-line text-center p-0" id="cantRam" value="1" style="height: 18px;">
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkDisco">
                                <label class="form-check-label label-text" for="checkDisco">DISCO DURO</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkVideo">
                                <label class="form-check-label label-text" for="checkVideo">TARJ. VIDEO</label>
                            </div>
                        </div>

                        <div class="col-md-4 cell-border cell-block py-1">
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkProc">
                                <label class="form-check-label label-text" for="checkProc">PROCESADOR</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkFan">
                                <label class="form-check-label label-text" for="checkFan">FAN COOLER</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkPila">
                                <label class="form-check-label label-text" for="checkPila">PILA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkFuente">
                                <label class="form-check-label label-text" for="checkFuente">FUENTE PODER</label>
                            </div>
                        </div>

                        <div class="col-md-4 cell-border cell-block py-1">
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkCanaima">
                                <label class="form-check-label label-text" for="checkCanaima">WIN/CANAIMA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkMadre">
                                <label class="form-check-label label-text" for="checkMadre">TARJ. MADRE</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input componente-check" type="checkbox" id="checkRed">
                                <label class="form-check-label label-text" for="checkRed">TARJ. RED</label>
                            </div>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-2 cell-border bg-light justify-content-center">
                            <span class="label-text">INCLUYE:</span>
                        </div>
                        <div class="col-10 cell-border flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input periferico-check" type="checkbox" value="Monitor" id="checkMonitor">
                                <label class="form-check-label label-text" for="checkMonitor">MONITOR</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input periferico-check" type="checkbox" value="Mouse" id="checkMouse">
                                <label class="form-check-label label-text" for="checkMouse">MOUSE</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input periferico-check" type="checkbox" value="Teclado" id="checkTeclado">
                                <label class="form-check-label label-text" for="checkTeclado">TECLADO</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input periferico-check" type="checkbox" value="Regulador" id="checkRegulador">
                                <label class="form-check-label label-text" for="checkRegulador">REGULADOR</label>
                            </div>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-2 cell-border bg-light justify-content-center">
                            <span class="label-text">APPS:</span>
                        </div>
                        <div class="col-10 cell-border flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input app-check" type="checkbox" value="Siquel">
                                <label class="label-text">SIQUEL</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input app-check" type="checkbox" value="SAP">
                                <label class="label-text">SAP</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input app-check" type="checkbox" value="Autocad">
                                <label class="label-text">AUTOCAD</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input app-check" type="checkbox" value="Project">
                                <label class="label-text">PROJECT</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row row-compact">
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">OTRA APP:</span>
                            <input type="text" class="input-line" id="otraApp">
                        </div>
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">CARPETA RED:</span>
                            <input type="text" class="input-line" id="carpetaRed">
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-12 cell-border cell-block">
                            <span class="label-text">OBSERVACI칍N:</span>
                            <textarea class="input-line" rows="1" id="observacion" style="resize: none;"></textarea>
                        </div>
                    </div>

                    <div class="row row-compact">
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">ASIGNADO A:</span>
                            <input type="text" class="input-line" id="asignadoA">
                        </div>
                        <div class="col-md-6 cell-border">
                            <span class="label-text me-2">ESTATUS:</span>
                            <input type="text" class="input-line" id="estatus">
                        </div>
                    </div>
                    <div class="row row-compact">
                        <div class="col-6 cell-border cell-block" style="height: 50px;">
                            <span class="label-text">ENTREGADO POR:</span>
                            <input type="text" class="input-line mt-2" id="entregadoPor">
                        </div>
                        <div class="col-6 cell-border cell-block" style="height: 50px;">
                            <span class="label-text">RECIBIDO POR:</span>
                            <input type="text" class="input-line mt-2" id="recibidoPor">
                        </div>
                    </div>
                    <%- include('../pages/recibo-equipos2') %>
                </div>
                <br>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    
    <script src="/js/api.js"></script> 
    
    <script>
        // Definimos la funci칩n de manera global para que el onclick del HTML la encuentre
        async function guardarRecibo() {
            console.log("Iniciando proceso de guardado...");

            // --- 1. DATOS DE USUARIO ---
            const usuario = document.getElementById('usuario').value;
            const clave = document.getElementById('clave').value;
            const ficha = parseInt(document.getElementById('ficha').value) || 0;
            const nombre = document.getElementById('nombre').value;
            const extension = document.getElementById('extension').value;
            const gerencia = document.getElementById('gerencia').value;

            // --- 2. LISTA DE NOMBRES DE CARPETAS ---
            const carpetasRaw = document.getElementById('carpetaRed').value;
            // Separa por comas, quita espacios y filtra vac칤os
            const nombresCarpetas = carpetasRaw 
                ? carpetasRaw.split(',').map(s => s.trim()).filter(s => s !== "") 
                : [];

            // --- 3. LISTA DE COMPONENTES (CANTIDADES) ---
            const componentes = [];
            
            // L칩gica para Memoria RAM (tiene input de cantidad)
            if(document.getElementById('checkRam').checked) {
                componentes.push({
                    idComponente: 1, // ID Ficticio RAM
                    cantidad: parseInt(document.getElementById('cantRam').value) || 1
                });
            }
            
            // L칩gica para el resto de checkboxes (cantidad 1)
            // Asignamos IDs ficticios basados en el orden + 2
            const otrosChecks = document.querySelectorAll('.componente-check:checked:not(#checkRam)');
            otrosChecks.forEach((check, index) => {
                componentes.push({
                    idComponente: index + 2, 
                    cantidad: 1
                });
            });

            // --- 4. LISTA DE SERIALES ---
            const seriales = [];

            // Funci칩n auxiliar para a침adir seriales 칰nicos
            const addSerial = (idTipo, marcaId, serialId, capId = null) => {
                const serialVal = document.getElementById(serialId)?.value;
                if(serialVal) {
                    seriales.push({
                        idTipoComponente: idTipo,
                        marca: document.getElementById(marcaId).value || "Gen칠rico",
                        serial: serialVal,
                        capacidad: capId ? document.getElementById(capId).value : "N/A"
                    });
                }
            };

            // Seriales 칰nicos de la base de datos (Madre, Fuente, Video, Red)
            addSerial(10, 'marcaMadre', 'serialMadre'); 
            addSerial(11, 'marcaFuente', 'serialFuente');
            addSerial(12, 'marcaVideo', 'serialVideo');
            addSerial(13, 'marcaRed', 'serialRed');

            // Seriales M칰ltiples (RAM - Filas din치micas)
            const ramsMarcas = document.querySelectorAll('.ram-marca');
            const ramsSeriales = document.querySelectorAll('.ram-serial');
            const ramsCaps = document.querySelectorAll('.ram-capacidad');
            
            ramsSeriales.forEach((inputSerial, i) => {
                if(inputSerial.value) {
                    seriales.push({
                        idTipoComponente: 1, // ID RAM
                        marca: ramsMarcas[i].value,
                        serial: inputSerial.value,
                        capacidad: ramsCaps[i].value
                    });
                }
            });

            // Seriales M칰ltiples (Disco Duro - Filas din치micas)
            const hddsMarcas = document.querySelectorAll('.hdd-marca');
            const hddsSeriales = document.querySelectorAll('.hdd-serial');
            const hddsCaps = document.querySelectorAll('.hdd-capacidad');

            hddsSeriales.forEach((inputSerial, i) => {
                if(inputSerial.value) {
                    seriales.push({
                        idTipoComponente: 2, // ID Disco Duro
                        marca: hddsMarcas[i].value,
                        serial: inputSerial.value,
                        capacidad: hddsCaps[i].value
                    });
                }
            });

            // --- 5. OBSERVACIONES (Concatenar Apps y Obs de Seriales) ---
            const obsGeneral = document.getElementById('observacion').value;
            const obsSeriales = document.getElementById('observacionSeriales') ? document.getElementById('observacionSeriales').value : "";
            const appsSeleccionadas = Array.from(document.querySelectorAll('.app-check:checked')).map(c => c.value).join(', ');
            
            let observacionFinal = obsGeneral;
            if(appsSeleccionadas) observacionFinal += " | Apps: " + appsSeleccionadas;
            if(obsSeriales) observacionFinal += " | Obs. Seriales: " + obsSeriales;


            // --- 6. ARMAR EL JSON FINAL (Estructura Solicitada) ---
            const payload = {
                usuario: usuario,
                clave: clave,
                gerencia: gerencia,
                nombre: nombre,
                ficha: ficha,
                extension: extension,
                recibos: [
                    {
                        asignadoA: document.getElementById('asignadoA').value,
                        entregadoPor: document.getElementById('entregadoPor').value,
                        fmoEquipo: document.getElementById('fmoEquipo').value,
                        estatus: document.getElementById('estatus').value,
                        falla: document.getElementById('falla').value,
                        fecha: document.getElementById('fecha').value, // Formato YYYY-MM-DD
                        observacion: observacionFinal,
                        recibidoPor: document.getElementById('recibidoPor').value,
                        solicitudDAET: document.getElementById('solicitudDAET').value,
                        solicitudST: document.getElementById('solicitudST').value,
                        equipos: [
                            {
                                marca: document.getElementById('marca').value,
                                respaldo: document.querySelector('input[name="respaldo"]:checked')?.value || 'NO',
                                nombresCarpetas: nombresCarpetas,
                                componentes: componentes,
                                seriales: seriales
                            }
                        ]
                    }
                ]
            };

            console.log("Payload a enviar:", JSON.stringify(payload, null, 2));

            // --- 7. ENV칈O AL BACKEND ---
            try {
                // NOTA: Se agreg칩 'http://' que faltaba en tu c칩digo
                const response = await fetch('http://127.0.0.1:8081/api/crearReciboEquipos', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const data = await response.json();
                console.log("Respuesta servidor:", data);
                alert("춰Recibo guardado exitosamente!");
                
                // Opcional: Recargar p치gina
                // window.location.reload();

            } catch (error) {
                console.error('Error al guardar:', error);
                alert("Error al guardar: " + error.message);
            }
        }
    </script>
</body>
</html>